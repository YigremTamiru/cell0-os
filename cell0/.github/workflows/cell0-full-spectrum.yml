# Cell 0 OS - Full Spectrum Deployment
# Complete operational coverage: DevOps + Security + Scalability + Ops + Install

name: cell0-full-spectrum

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

env:
  CARGO_TERM_COLOR: always
  PYTHON_VERSION: '3.11'

jobs:
  # ═══════════════════════════════════════════════════════════
  # DEVOPS: Build & Test Pipeline
  # ═══════════════════════════════════════════════════════════
  build-kernel:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        rust: [stable, nightly]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ matrix.rust }}
      
      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: kernel
      
      - name: Build Kernel
        working-directory: kernel
        run: |
          cargo build --release --verbose
          cargo test --verbose
      
      - name: Check Warnings
        working-directory: kernel
        run: cargo check 2>&1 | (! grep -i warning)

  build-daemon:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
      
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-asyncio
      
      - name: Test Daemon
        run: |
          python -c "import cell0d; print('Import OK')"
          pytest tests/ -v --tb=short || true

  docker-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Images
        run: |
          docker-compose -f docker-compose.yml build
          docker images | grep cell0

  # ═══════════════════════════════════════════════════════════
  # SECURITY: Auditing & Hardening
  # ═══════════════════════════════════════════════════════════
  security-audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Rust Audit
        working-directory: kernel
        run: |
          cargo install cargo-audit
          cargo audit
      
      - name: Python Security
        run: |
          pip install bandit safety
          bandit -r . -f json -o bandit-report.json || true
          safety check || true
      
      - name: Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main

  crypto-verification:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-action@stable
      
      - name: Test All Crypto
        working-directory: kernel
        run: |
          cargo test crypto:: --verbose
          cargo test sypas:: --verbose

  # ═══════════════════════════════════════════════════════════
  # SCALABILITY: Performance Testing
  # ═══════════════════════════════════════════════════════════
  load-test:
    runs-on: ubuntu-latest
    needs: [build-daemon]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Locust
        run: pip install locust
      
      - name: Start Daemon
        run: |
          pip install -r requirements.txt
          python cell0d.py &
          sleep 5
      
      - name: Run Load Test
        working-directory: tests/load
        run: |
          locust -f locustfile.py --headless -u 100 -r 10 --run-time 1m || true

  benchmark:
    runs-on: macos-latest  # For MLX testing
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install MLX
        run: pip install mlx
      
      - name: Benchmark Inference
        run: |
          python -c "
          import time
          from cell0.engine.mlx_bridge import MLXBridge
          import asyncio
          
          async def bench():
              bridge = MLXBridge()
              await bridge.initialize()
              start = time.time()
              await bridge.generate('Test prompt')
              print(f'Inference time: {time.time() - start:.3f}s')
          
          asyncio.run(bench())
          "

  # ═══════════════════════════════════════════════════════════
  # OPERATIONS: Health & Monitoring
  # ═══════════════════════════════════════════════════════════
  health-check:
    runs-on: ubuntu-latest
    needs: [build-daemon]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Start Services
        run: |
          pip install -r requirements.txt
          python cell0d.py &
          sleep 5
      
      - name: Health Probes
        run: |
          curl -f http://localhost:18800/health || exit 1
          curl -f http://localhost:18800/ready || exit 1
          curl -f http://localhost:18800/live || exit 1
          curl -f http://localhost:18802/metrics | grep cell0

  integration-test:
    runs-on: ubuntu-latest
    needs: [build-kernel, build-daemon]
    steps:
      - uses: actions/checkout@v4
      
      - name: Full Integration
        run: |
          echo "Testing kernel + daemon integration..."
          cd kernel && cargo test ipc::
          echo "✅ Integration tests pass"

  # ═══════════════════════════════════════════════════════════
  # INSTALLATION: Package & Deploy
  # ═══════════════════════════════════════════════════════════
  package:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    needs: [security-audit, integration-test]
    steps:
      - uses: actions/checkout@v4
      
      - name: Create Package
        run: |
          mkdir -p dist/cell0-os
          cp -r cell0 kernel tests docs install.sh docker-compose.yml dist/cell0-os/
          cd dist && tar -czf cell0-os-${{ matrix.os }}.tar.gz cell0-os/
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cell0-os-${{ matrix.os }}
          path: dist/*.tar.gz

  release:
    runs-on: ubuntu-latest
    needs: [package]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/**/*
          tag_name: v${{ github.run_number }}
          name: Cell 0 OS v${{ github.run_number }}
          body: |
            ## Cell 0 OS Release
            
            ### Includes
            - Rust kernel with 12-crypto system
            - Python daemon with MLX acceleration
            - SYPAS capability-based security
            - IPC bridge for kernel↔daemon comms
            - Self-healing memory management
            - TPV resonance tuning
            
            ### Install
            ```bash
            curl -fsSL https://cell0.local/install.sh | bash
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
