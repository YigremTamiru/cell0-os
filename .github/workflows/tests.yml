name: Cell 0 OS Tests

on:
  push:
    branches: [ main, develop, 'feature/**' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'memory/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'memory/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Bootstrap Validation Job
  # ============================================================================
  bootstrap:
    name: Bootstrap Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Validate file structure
      run: |
        echo "Checking required files..."
        test -f requirements.txt || (echo "Missing requirements.txt" && exit 1)
        test -f requirements-test.txt || (echo "Missing requirements-test.txt" && exit 1)
        test -f tests/run_tests.sh || (echo "Missing tests/run_tests.sh" && exit 1)
        test -f tests/conftest.py || (echo "Missing tests/conftest.py" && exit 1)
        test -f tests/test_bootstrap.py || (echo "Missing tests/test_bootstrap.py" && exit 1)
        echo "✓ All required files present"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run bootstrap tests
      run: |
        pytest tests/test_bootstrap.py -v --tb=short

  # ============================================================================
  # Unit Tests Job
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: bootstrap
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-${{ matrix.python-version }}-
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run unit tests
      run: |
        pytest tests/ -v -m "not integration and not slow" --tb=short

  # ============================================================================
  # Integration Tests Job
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: unit-tests
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run integration tests
      run: |
        pytest tests/ -v -m integration --tb=short
      continue-on-error: true  # Don't block PRs on integration tests

  # ============================================================================
  # Coverage Job
  # ============================================================================
  coverage:
    name: Coverage Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: unit-tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: Run tests with coverage
      run: |
        pytest tests/ -v --cov=col --cov=engine --cov=service --cov=cell0 --cov-report=xml --cov-report=term-missing
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
      continue-on-error: true
    
    - name: Check coverage threshold
      run: |
        python -c "
import xml.etree.ElementTree as ET
root = ET.parse('coverage.xml').getroot()
rate = float(root.get('line-rate')) * 100
print(f'Coverage: {rate:.2f}%')
if rate < 50:
    print('ERROR: Coverage below 50%')
    exit(1)
print('Coverage threshold passed')
"

  # ============================================================================
  # Lint and Format Check Job
  # ============================================================================
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
    
    - name: Run flake8
      run: |
        flake8 col/ engine/ service/ cell0/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
    
    - name: Check black formatting
      run: |
        black --check col/ engine/ service/ cell0/ || true
    
    - name: Check isort formatting
      run: |
        isort --check-only col/ engine/ service/ cell0/ || true
    
    - name: Run mypy type check
      run: |
        mypy col/ engine/ service/ cell0/ --ignore-missing-imports || true

  # ============================================================================
  # Security Scan Job
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Bandit security scan
      run: |
        pip install bandit
        bandit -r col/ engine/ service/ cell0/ -f json -o bandit-report.json || true
        bandit -r col/ engine/ service/ cell0/ || true
    
    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json

  # ============================================================================
  # Test Summary Job
  # ============================================================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [bootstrap, unit-tests, coverage, lint]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true
    
    - name: Summarize test results
      run: |
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Bootstrap | ${{ needs.bootstrap.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.bootstrap.result }}" == "success" && \
              "${{ needs.unit-tests.result }}" == "success" && \
              "${{ needs.coverage.result }}" == "success" ]]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All critical tests passed!" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ Some tests failed." >> $GITHUB_STEP_SUMMARY
          exit 1
        fi
