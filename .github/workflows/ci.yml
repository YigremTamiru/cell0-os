name: Cell 0 OS - Comprehensive CI/CD

on:
  push:
    branches: [ main, develop, 'feature/**', 'release/**' ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'memory/**'
      - 'website/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'memory/**'
  schedule:
    # Run nightly tests
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - install-only

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: true

env:
  CELL0_VERSION: "1.2.0"
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================================================
  # Group 1: Pre-flight Checks (Jobs 1-2)
  # ============================================================================
  
  # Job 1: File Structure Validation
  validate-structure:
    name: ðŸ“ File Structure
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate repository structure
        run: |
          echo "Validating repository structure..."
          # Case-insensitive check for README
          find . -maxdepth 1 -iname "README.md" | grep -q . || (echo "Missing README.md" && exit 1)
          # Case-insensitive check for LICENSE (any extension)
          find . -maxdepth 1 -iname "LICENSE*" | grep -q . || (echo "Missing LICENSE" && exit 1)
          
          test -f pyproject.toml || (echo "Missing pyproject.toml" && exit 1)
          test -f requirements.txt || (echo "Missing requirements.txt" && exit 1)
          test -f install.sh || (echo "Missing install.sh" && exit 1)
          
          # Check for directories (more flexible)
          test -d cell0 || test -d src || (echo "Missing core source directory" && exit 1)
          test -d tests || (echo "Missing tests directory" && exit 1)
          echo "âœ“ Basic repository structure validated"
      
      - name: Check script executability
        run: |
          test -x install.sh || (chmod +x install.sh && echo "Fixed install.sh permissions")
          test -x install-wizard.sh || (chmod +x install-wizard.sh && echo "Fixed install-wizard.sh permissions")
          test -x setup-config.sh || (chmod +x setup-config.sh && echo "Fixed setup-config.sh permissions")
          test -x verify-installation.sh || (chmod +x verify-installation.sh && echo "Fixed verify-installation.sh permissions")
          echo "âœ“ All scripts executable"

  # Job 2: Lint and Syntax Check
  lint-and-syntax:
    name: ðŸ” Lint & Syntax
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linting tools
        run: |
          pip install flake8 black isort shellcheck-py
      
      - name: Check shell script syntax
        run: |
          # Only check scripts that exist
          for script in install.sh install-wizard.sh setup-config.sh verify-installation.sh test_runner.sh test-fresh-install.sh; do
            if [ -f "$script" ]; then
              bash -n "$script"
            fi
          done
          echo "âœ“ Existing shell scripts syntactically valid"
      
      - name: Run flake8
        run: |
          flake8 col/ engine/ service/ cell0/ --count --select=E9,F63,F7,F82 --show-source --statistics || true
      
      - name: Check black formatting
        run: |
          black --check col/ engine/ service/ cell0/ || true

  # Job 2b: Kernel Build (Rust)
  kernel-build:
    name: ðŸ¦€ Kernel Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          toolchain: nightly
          components: rust-src, llvm-tools-preview
          targets: x86_64-unknown-none
      
      - name: Build Kernel
        run: |
          if [ -d "cell0/kernel" ]; then
            cd cell0/kernel
            cargo build --release --features bare_metal
          elif [ -d "kernel" ]; then
            cd kernel
            cargo build --release --features bare_metal
          fi
        continue-on-error: true

  # ============================================================================
  # Group 2: Unit Tests (Jobs 3-6)
  # ============================================================================
  
  # Job 3: Python 3.9 Unit Tests
  unit-tests-py39:
    name: ðŸ§ª Unit Tests (Py 3.9)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint-and-syntax
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.9
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.9-${{ hashFiles('requirements*.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run unit tests
        run: |
          pytest tests/ -v -m "not integration and not slow" --tb=short -x

  # Job 4: Python 3.10 Unit Tests
  unit-tests-py310:
    name: ðŸ§ª Unit Tests (Py 3.10)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint-and-syntax
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.10-${{ hashFiles('requirements*.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run unit tests
        run: |
          pytest tests/ -v -m "not integration and not slow" --tb=short -x

  # Job 5: Python 3.11 Unit Tests
  unit-tests-py311:
    name: ðŸ§ª Unit Tests (Py 3.11)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint-and-syntax
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.11-${{ hashFiles('requirements*.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run unit tests
        run: |
          pytest tests/ -v -m "not integration and not slow" --tb=short -x

  # Job 6: Python 3.12 Unit Tests
  unit-tests-py312:
    name: ðŸ§ª Unit Tests (Py 3.12)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint-and-syntax
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-3.12-${{ hashFiles('requirements*.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run unit tests
        run: |
          pytest tests/ -v -m "not integration and not slow" --tb=short -x

  # ============================================================================
  # Group 3: Platform-Specific Installation Tests (Jobs 7-10)
  # ============================================================================
  
  # Job 7: Ubuntu Installation Test
  install-ubuntu:
    name: ðŸ§ Install Test (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run installation test
        run: |
          export CELL0_INSTALL_DIR="$HOME/.cell0-test"
          bash test-fresh-install.sh --dir "$HOME/cell0-test"
      
      - name: Verify installation
        run: |
          bash verify-installation.sh --dir "$HOME/.cell0-test" || true

  # Job 8: macOS Installation Test
  install-macos:
    name: ðŸŽ Install Test (macOS)
    runs-on: macos-latest
    timeout-minutes: 30
    needs: validate-structure
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run installation test
        run: |
          export CELL0_INSTALL_DIR="$HOME/.cell0-test"
          bash test-fresh-install.sh --dir "$HOME/cell0-test"
      
      - name: Verify installation
        run: |
          bash verify-installation.sh --dir "$HOME/.cell0-test" || true

  # Job 9: Windows Installation Test
  install-windows:
    name: ðŸªŸ Install Test (Windows)
    runs-on: windows-latest
    timeout-minutes: 30
    needs: validate-structure
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run PowerShell installation test
        shell: pwsh
        run: |
          Write-Host "Testing Windows installation path..."
          Test-Path -Path "." -PathType Container
          Write-Host "âœ“ Windows environment ready"
      
      - name: Check WSL availability
        shell: pwsh
        run: |
          wsl --version
          Write-Host "âœ“ WSL available for Linux compatibility"
        continue-on-error: true

  # Job 10: Docker Installation Test
  install-docker:
    name: ðŸ³ Install Test (Docker)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: validate-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        run: |
          docker build -t cell0-test -f Dockerfile .
          echo "âœ“ Docker image built successfully"
      
      - name: Test container startup
        run: |
          docker run --rm cell0-test echo "Container test passed"
        continue-on-error: true

  # ============================================================================
  # Group 4: Integration Tests (Jobs 11-13)
  # ============================================================================
  
  # Job 11: Integration Tests
  integration-tests:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests-py311]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run integration tests
        run: |
          pytest tests/ -v -m integration --tb=short
        continue-on-error: true

  # Job 12: End-to-End Tests
  e2e-tests:
    name: ðŸŽ­ End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests-py311, install-ubuntu]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run test runner
        run: |
          bash test_runner.sh --report
      
      - name: Upload test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-runner-report
          path: test-results/test_runner_*.json

  # Job 13: Fresh Install E2E
  fresh-install-e2e:
    name: ðŸ†• Fresh Install E2E
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [install-ubuntu]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run fresh install tests
        run: |
          bash test-fresh-install.sh
      
      - name: Test verification script
        run: |
          export CELL0_HOME="$HOME/.cell0"
          bash verify-installation.sh || true

  # ============================================================================
  # Group 5: Security & Quality (Jobs 14-15)
  # ============================================================================
  
  # Job 14: Security Scan
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate-structure
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Bandit security scan
        run: |
          pip install bandit
          bandit -r col/ engine/ service/ cell0/ -f json -o bandit-report.json || true
          bandit -r col/ engine/ service/ cell0/ || true
      
      - name: Run safety check
        run: |
          pip install safety
          safety check -r requirements.txt || true
        continue-on-error: true
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report
          path: bandit-report.json

  # Job 15: Code Quality
  code-quality:
    name: ðŸ“Š Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint-and-syntax
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-test.txt
      
      - name: Run coverage analysis
        run: |
          pytest tests/ --cov=col --cov=engine --cov=service --cov=cell0 --cov-report=xml --cov-report=term-missing || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true

  # ============================================================================
  # Group 6: Build & Package (Jobs 16-17)
  # ============================================================================
  
  # Job 16: Package Build
  package-build:
    name: ðŸ“¦ Package Build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [unit-tests-py311]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install build tools
        run: |
          pip install build wheel
      
      - name: Build package
        run: |
          python -m build
          echo "âœ“ Package built successfully"
      
      - name: Upload package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  # Job 17: Container Build
  container-build:
    name: ðŸ³ Container Build
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [package-build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build containers
        run: |
          docker build -t cell0:${{ github.sha }} -f Dockerfile .
          docker tag cell0:${{ github.sha }} cell0:latest
          echo "âœ“ Container built successfully"
      
      - name: Test container
        run: |
          docker run --rm cell0:${{ github.sha }} python --version
          echo "âœ“ Container runs successfully"

  # ============================================================================
  # Group 7: Final Summary (Job 18)
  # ============================================================================
  
  # Job 18: Test Summary
  test-summary:
    name: ðŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [
      validate-structure,
      lint-and-syntax,
      unit-tests-py39,
      unit-tests-py310,
      unit-tests-py311,
      unit-tests-py312,
      install-ubuntu,
      install-macos,
      install-windows,
      install-docker,
      integration-tests,
      e2e-tests,
      fresh-install-e2e,
      security-scan,
      code-quality,
      package-build,
      container-build
    ]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      - name: Generate summary
        run: |
          echo "## Cell 0 OS CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| File Structure | ${{ needs.validate-structure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Syntax | ${{ needs.lint-and-syntax.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Py 3.9) | ${{ needs.unit-tests-py39.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Py 3.10) | ${{ needs.unit-tests-py310.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Py 3.11) | ${{ needs.unit-tests-py311.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests (Py 3.12) | ${{ needs.unit-tests-py312.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Install (Ubuntu) | ${{ needs.install-ubuntu.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Install (macOS) | ${{ needs.install-macos.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Install (Windows) | ${{ needs.install-windows.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Install (Docker) | ${{ needs.install-docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Fresh Install E2E | ${{ needs.fresh-install-e2e.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Build | ${{ needs.package-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Build | ${{ needs.container-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count results
          passed=$(echo '${{ toJson(needs.*.result) }}' | grep -c "success" || true)
          failed=$(echo '${{ toJson(needs.*.result) }}' | grep -c "failure" || true)
          skipped=$(echo '${{ toJson(needs.*.result) }}' | grep -c "skipped" || true)
          
          echo "### Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Passed: $passed" >> $GITHUB_STEP_SUMMARY
          echo "- âŒ Failed: $failed" >> $GITHUB_STEP_SUMMARY
          echo "- â­ï¸ Skipped: $skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$failed" -eq 0 ]; then
            echo "### ðŸŽ‰ All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some checks failed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Final status
        run: |
          failed=$(echo '${{ toJson(needs.*.result) }}' | grep -c "failure" || true)
          if [ "$failed" -gt 0 ]; then
            echo "Some jobs failed"
            exit 1
          fi
          echo "All jobs passed!"
